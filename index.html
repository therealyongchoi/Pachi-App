<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Counter & Converter">
    <title data-i18n="appTitle">Counter & Points Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative; /* Needed for sidebar positioning */
            overflow-x: hidden; /* Prevent horizontal scroll when sidebar is out */
            color: #333; /* Default text color */
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Base Styles - will be overridden by specific color schemes */
        body.dark-mode {
            color: #ecf0f1; /* Light text color in dark mode */
        }

        body.dark-mode .container {
            background: rgba(44, 62, 80, 0.95); /* Default dark container bg */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode h1, body.dark-mode h2 {
            color: #ecf0f1;
        }

        body.dark-mode .counter-display {
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #a7c4ff;
        }

        body.dark-mode .currency-counter-display {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid rgba(40, 167, 69, 0.3);
            color: #90ee90;
        }

        body.dark-mode label {
            color: #bdc3c7;
        }

        body.dark-mode input[type="number"],
        body.dark-mode .history-notes-textbox {
            background: #34495e;
            border-color: #4a647c;
            color: #ecf0f1;
        }

        body.dark-mode input[type="number"]:focus {
            border-color: #85a8f9;
            box-shadow: 0 0 0 3px rgba(133, 168, 249, 0.3);
        }

        body.dark-mode .currency-output {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid rgba(40, 167, 69, 0.3);
            color: #90ee90;
        }

        body.dark-mode .history-list {
            background: rgba(44, 62, 80, 0.8);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        body.dark-mode .history-item {
            border-bottom: 1px dashed rgba(255,255,255,0.1);
        }

        body.dark-mode .history-number,
        body.dark-mode .history-details {
            color: #ecf0f1;
        }

        body.dark-mode .history-datetime {
            color: #bdc3c7;
        }

        body.dark-mode .menu-icon {
            background: rgba(44, 62, 80, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode .menu-icon span {
            background: #ecf0f1;
        }

        body.dark-mode .sidebar {
            background: rgba(52, 73, 94, 0.8); /* Adjusted for frosted glass effect */
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
        }

        body.dark-mode .sidebar-menu-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        body.dark-mode .sidebar-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode .sidebar-menu-item.active {
            background: rgba(255, 255, 255, 0.15);
        }


        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            width: 100%; /* Ensure it takes full available width */
            max-width: 600px; /* Consistent max-width for all containers */
            margin: 0 auto; /* Center the container */
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 700;
        }

        h2 {
            text-align: center;
            color: #555;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* Main counter section layout */
        .counter-main-section {
            display: flex;
            flex-direction: column; /* Stack counter display, buttons, and reset vertically */
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Container for increment buttons */
        .counter-buttons-row {
            display: flex;
            justify-content: center;
            gap: 15px; /* Space between buttons */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .counter-display {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            min-width: 100px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        /* Style for the converted counter value display */
        .currency-counter-display {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin-top: 10px;
            padding: 15px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(40, 167, 69, 0.2);
            min-width: 100px;
            text-align: center;
        }

        .counter-button {
            font-size: 1.5rem;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .counter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .counter-button:active {
            transform: translateY(0);
        }

        .converter-section {
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 1.1rem;
        }

        input[type="number"] {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            background: white;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .currency-output {
            font-size: 1.5rem; /* Adjusted for two lines of text */
            font-weight: bold;
            color: #28a745;
            margin-top: 20px;
            padding: 20px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(40, 167, 69, 0.2);
            min-height: 80px;
            display: flex;
            flex-direction: column; /* To stack the two lines of text */
            align-items: center;
            justify-content: center;
            gap: 10px; /* Space between the two lines */
        }

        .reset-button, .save-button, .remove-history-button, .save-winnings-button {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            margin-top: 10px; /* Default margin-top for these buttons */
        }
        .save-button {
            background: #28a745; /* Green for save */
        }
        .remove-history-button {
            background: #ffc107; /* Warning yellow for remove */
            color: #333;
        }
        .save-winnings-button {
            background: #007bff; /* Blue for save winnings */
            margin-top: 20px; /* More space for this button */
        }

        .reset-button:hover {
            background: #c82333;
        }
        .save-button:hover {
            background: #218838;
        }
        .remove-history-button:hover {
            background: #e0a800;
        }
        .save-winnings-button:hover {
            background: #0056b3;
        }


        /* New styles for currency toggle buttons */
        .currency-toggle-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .currency-toggle-button {
            padding: 10px 20px;
            background: #ccc;
            color: #333;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .currency-toggle-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        /* History list styles */
        .history-list {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            max-height: 300px; /* Scrollable history */
            overflow-y: auto;
            margin-top: 20px; /* Space above history list */
        }

        .history-item {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            align-items: flex-start; /* Align checkbox and line content vertically */
            gap: 10px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item input[type="checkbox"] {
            transform: scale(1.2); /* Make checkbox slightly larger */
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 5px; /* Align with the first line of text */
        }

        .history-item-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Allow the content to take available space */
        }

        .history-item-line {
            display: flex;
            justify-content: space-between; /* Space out items in the line */
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 5px 15px; /* Vertical and horizontal gap */
            margin-bottom: 5px; /* Space between line and notes */
        }

        .history-number {
            font-weight: bold;
            color: #555;
            flex-shrink: 0; /* Prevent number from shrinking */
        }

        .history-datetime {
            color: #777;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .history-details {
            font-weight: 600;
            color: #333;
            text-align: right; /* Align details to the right within its space */
            flex-grow: 1; /* Allow details to take remaining space */
            white-space: nowrap; /* Keep details on one line if possible */
            overflow: hidden; /* Hide overflow if too long */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        .history-notes-textbox {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical; /* Allow vertical resizing */
            min-height: 40px; /* Minimum height for notes */
            margin-top: 5px; /* Space between details and notes */
        }

        /* --- Menu Bar Styles --- */
        .menu-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001; /* Above other content */
            cursor: pointer;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 40px;
            height: 40px;
            justify-content: center;
            align-items: center;
        }

        .menu-icon span {
            display: block;
            width: 30px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .menu-icon.open span:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }
        .menu-icon.open span:nth-child(2) {
            opacity: 0;
        }
        .menu-icon.open span:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px; /* Width of the sidebar */
            height: 100%;
            background: rgba(118, 75, 162, 0.8); /* Semi-transparent background for frosted glass */
            z-index: 1000;
            transform: translateX(-100%); /* Initially hidden */
            transition: transform 0.3s ease-in-out;
            padding-top: 80px; /* Space for menu icon */
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
        }

        .sidebar.open {
            transform: translateX(0); /* Slide in */
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; /* For icon alignment */
            align-items: center;
        }

        .sidebar-menu-item svg {
            margin-right: 10px; /* Space between icon and text */
            width: 20px;
            height: 20px;
            fill: white; /* Icon color */
        }

        .sidebar-menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-menu-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-left: 5px solid white;
            padding-left: 15px;
        }

        /* Push settings to bottom */
        #menuSettings {
            margin-top: auto; /* Pushes this item to the bottom */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Add a top border */
        }

        /* Currency Toggle in Sidebar */
        .sidebar-currency-toggle {
            display: flex;
            margin: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-currency-toggle .toggle-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: white;
            border-radius: 25px;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .sidebar-currency-toggle.jpy-active .toggle-background {
            transform: translateX(100%);
        }

        .sidebar-currency-toggle button {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1; /* Ensure text is above background */
            transition: color 0.3s ease;
        }

        .sidebar-currency-toggle button.active {
            color: #667eea; /* Color when active and background is white */
        }

        body.dark-mode .sidebar-currency-toggle .toggle-background {
            background: #1a252f; /* Darker background for toggle in dark mode */
        }
        body.dark-mode .sidebar-currency-toggle button.active {
            color: #a7c4ff; /* Lighter color for active text in dark mode */
        }


        /* --- Content Sections --- */
        #mainContent {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            align-items: center; /* Center content sections */
        }

        .content-section {
            display: none; /* Hide all content sections by default */
            width: 100%;
            padding-top: 0; /* Containers handle their own padding */
        }

        .content-section.active {
            display: flex; /* Show active section */
            flex-direction: column;
            align-items: center;
        }

        /* Adjust body padding when sidebar is open to prevent content overlap */
        body.sidebar-open {
            padding-left: 270px; /* Sidebar width + gap */
        }

        /* Settings specific styles */
        #settingsSection h2 {
            margin-bottom: 30px; /* More space below settings title */
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            gap: 15px; /* Added gap between label and select */
        }
        .settings-option:last-child {
            border-bottom: none;
        }
        .settings-option label {
            font-weight: 600;
            margin-bottom: 0; /* Override default label margin */
            flex-shrink: 0; /* Prevent label from shrinking */
            text-align: left; /* Ensure label text is left-aligned */
            flex-basis: 40%; /* Give labels a fixed basis to align */
            max-width: 40%; /* Prevent labels from getting too wide */
        }

        /* Dropdown for Dark Mode */
        .dark-mode-select, .language-select, .dark-mode-color-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s ease;
            flex-grow: 1; /* Allow select boxes to grow */
            text-align: right; /* Align text within select to the right */
            -moz-appearance: none; /* Firefox */
            -webkit-appearance: none; /* Chrome, Safari */
            appearance: none; /* Standard */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.4c-6.8%200-13.2%203.6-16.4%209.6-3.2%206-3.2%2012.4%200%2018.4l128%20128c3.2%203.2%207.2%204.8%2011.2%204.8s8-1.6%2011.2-4.8l128-128c3.2-6%203.2-12.4%200-18.4z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px; /* Space for the custom arrow */
        }
        .dark-mode-select:focus, .language-select:focus, .dark-mode-color-select:focus {
            outline: none;
            border-color: #667eea;
        }

        body.dark-mode .dark-mode-select,
        body.dark-mode .language-select,
        body.dark-mode .dark-mode-color-select {
            background-color: #34495e;
            color: #ecf0f1;
            border-color: #4a647c;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.4c-6.8%200-13.2%203.6-16.4%209.6-3.2%206-3.2%2012.4%200%2018.4l128%20128c3.2%203.2%207.2%204.8%2011.2%204.8s8-1.6%2011.2-4.8l128-128c3.2-6%203.2-12.4%200-18.4z%22%2F%3E%3C%2Fsvg%3E'); /* White arrow for dark mode */
        }

        /* Numpad styles */
        .numpad-container {
            margin-top: 20px;
            width: 100%;
            max-width: 300px; /* Align with input field */
            margin-left: auto;
            margin-right: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        body.dark-mode .numpad-container {
            background: rgba(44, 62, 80, 0.9);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .numpad-button {
            padding: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            background: #eee;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #333;
        }

        .numpad-button:hover {
            background: #ddd;
            transform: translateY(-1px);
        }

        .numpad-button:active {
            background: #ccc;
            transform: translateY(0);
        }

        .numpad-button.action-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            grid-column: span 1; /* Ensure action buttons take one column */
        }
        .numpad-button.action-button:hover {
            background: linear-gradient(135deg, #5a6ed1, #6b4093);
        }

        .numpad-button.clear-button {
            background: #dc3545;
            color: white;
        }
        .numpad-button.clear-button:hover {
            background: #c82333;
        }

        .numpad-button.delete-button {
            background: #ffc107;
            color: #333;
        }
        .numpad-button.delete-button:hover {
            background: #e0a800;
        }

        body.dark-mode .numpad-button {
            background: #34495e;
            color: #ecf0f1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        body.dark-mode .numpad-button:hover {
            background: #4a647c;
        }
        body.dark-mode .numpad-button.action-button {
            background: linear-gradient(135deg, #4a5d8f, #5d4a8f);
        }
        body.dark-mode .numpad-button.action-button:hover {
            background: linear-gradient(135deg, #5c70a1, #705c9f);
        }
        body.dark-mode .numpad-button.clear-button {
            background: #a73545;
        }
        body.dark-mode .numpad-button.clear-button:hover {
            background: #b82333;
        }
        body.dark-mode .numpad-button.delete-button {
            background: #cc9900;
            color: #ecf0f1;
        }
        body.dark-mode .numpad-button.delete-button:hover {
            background: #e0a800;
        }

        /* Deduction Percentage Selector Styles */
        .deduction-selector {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the selector horizontally */
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px; /* Match input width */
            margin-left: auto;
            margin-right: auto;
        }

        .deduction-button {
            padding: 8px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        .deduction-button:hover {
            background: #5a6ed1;
        }
        .deduction-button:active {
            transform: translateY(1px);
        }

        .deduction-value-display {
            padding: 10px 15px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            color: #333;
            min-width: 80px; /* Ensure enough space for value */
            text-align: center;
            flex-grow: 1; /* Allow display to grow */
        }

        body.dark-mode .deduction-button {
            background: #4a5d8f;
        }
        body.dark-mode .deduction-button:hover {
            background: #5c70a1;
        }
        body.dark-mode .deduction-value-display {
            background: #34495e;
            border-color: #4a647c;
            color: #ecf0f1;
        }


        @media (max-width: 480px) {
            .counter-main-section {
                gap: 15px;
            }
            
            .counter-display {
                font-size: 2.5rem;
            }
            
            .counter-button {
                font-size: 1.2rem;
                padding: 12px 25px;
            }
            
            h1 {
                font-size: 1.5rem;
            }

            .history-item-line {
                flex-direction: column; /* Stack elements vertically on small screens */
                align-items: flex-start;
                gap: 5px;
            }
            .history-details {
                text-align: left; /* Align details to left on small screens */
            }

            .sidebar {
                width: 200px; /* Smaller sidebar on small screens */
            }
            body.sidebar-open {
                padding-left: 220px; /* Adjusted padding */
            }

            .settings-option label {
                flex-basis: auto; /* Remove fixed basis on small screens */
                max-width: none; /* Remove max-width on small screens */
                margin-right: 0; /* Remove margin-right on small screens */
                width: 100%; /* Take full width */
                text-align: left;
                margin-bottom: 5px; /* Add some space below label */
            }

            .dark-mode-select, .language-select, .dark-mode-color-select {
                width: 100%; /* Take full width */
                max-width: none; /* Remove max-width on small screens */
                text-align: left; /* Align text within select to the left on small screens */
                padding-right: 15px; /* Adjust padding for arrow */
            }
            .settings-option {
                flex-direction: column; /* Stack label and select vertically */
                align-items: flex-start; /* Align items to the start */
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Icon -->
    <div class="menu-icon" id="menuIcon">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Sidebar Menu -->
    <nav class="sidebar" id="sidebar">
        <!-- New Currency Toggle in Sidebar - Moved to top -->
        <div class="sidebar-currency-toggle" id="sidebarCurrencyToggle">
            <div class="toggle-background"></div>
            <button id="sidebarToggleVND" data-i18n="vndShort">VND</button>
            <button id="sidebarToggleJPY" data-i18n="jpyShort">JPY</button>
        </div>

        <div class="sidebar-menu-item" id="menuCounter" data-i18n="menuCounter">Counter & History</div>
        <div class="sidebar-menu-item" id="menuVNDConversion" data-i18n="menuVNDConversion">VND Conversion</div>
        <div class="sidebar-menu-item" id="menuJPYConversion" data-i18n="menuJPYConversion">JPY Conversion</div>
        <div class="sidebar-menu-item" id="menuWinningsHistory" data-i18n="menuWinningsHistory">Winnings History</div>
        
        <div class="sidebar-menu-item" id="menuSettings">
            <!-- Cogwheel Icon SVG -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M19.4 12.98c.04-.32.06-.65.06-.98s-.02-.66-.06-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.1-.65-1.7-.82l-.34-2.61c-.05-.24-.26-.42-.5-.42h-4c-.25 0-.46.18-.5.42l-.34 2.61c-.6.17-1.18.43-1.7.82l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.12.22-.07.49.12.64l2.11 1.65c-.04.32-.06.65-.06.98s.02.66.06.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.31.61.22l2.49-1c.52.39 1.1.65 1.7.82l.34 2.61c.05.24.26.42.5.42h4c.25 0 .46-.18.5-.42l.34-2.61c.6-.17 1.18-.43 1.7-.82l2.49 1c.22.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
            </svg>
            <span data-i18n="menuSettingsText">Settings</span>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="mainContent">
        <!-- Counter and Session History Section -->
        <div id="counterSection" class="content-section active container">
            <h1 data-i18n="pachiTitle">Pachi</h1>
            
            <div class="counter-main-section">
                <h2 data-i18n="counterTitle">Counter</h2>

                <!-- Currency toggle removed from here -->
            
                <div class="counter-display" id="counter">0</div>
                
                <div class="counter-buttons-row">
                    <button class="counter-button" id="increment1">+1</button>
                    <button class="counter-button" id="increment5">+5</button>
                    <button class="counter-button" id="increment10">+10</button>
                </div>
                <button class="reset-button" id="resetCounterButton" data-i18n="resetCounterButton">Reset Session Counter</button>
                <button class="save-button" id="saveSessionButton" data-i18n="saveSessionButton">Save Session</button>
                <div class="currency-counter-display" id="convertedCounterValue">0 VND</div>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid rgba(0,0,0,0.1);">

            <div>
                <h2 data-i18n="sessionHistoryTitle">Session History</h2>
                <button class="remove-history-button" id="removeCheckedHistoryButton" data-i18n="removeHistoryButton">Remove Checked History</button>
                <div id="sessionHistoryList" class="history-list">
                    <p data-i18n="loadingHistory">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- Points to VND Converter Section -->
        <div id="vndConversionSection" class="content-section container">
            <h2 data-i18n="vndConverterTitle">Points to VND Converter</h2>
            
            <div class="converter-section">
                <div class="input-group">
                    <label for="pointsInputVND" data-i18n="enterPointsLabel">Enter Points:</label>
                    <input type="number" id="pointsInputVND" placeholder="Enter points..." min="0" inputmode="none">
                </div>
                
                <div class="currency-output" id="currencyOutputVND">
                    <span data-i18n="enterPointsVND">Enter points to see VND value</span>
                </div>

                <!-- Numpad for VND Converter -->
                <div class="numpad-container" id="numpadVND">
                    <div class="numpad-grid">
                        <button class="numpad-button">1</button>
                        <button class="numpad-button">2</button>
                        <button class="numpad-button">3</button>
                        <button class="numpad-button">4</button>
                        <button class="numpad-button">5</button>
                        <button class="numpad-button">6</button>
                        <button class="numpad-button">7</button>
                        <button class="numpad-button">8</button>
                        <button class="numpad-button">9</button>
                        <button class="numpad-button clear-button" data-action="clear">C</button>
                        <button class="numpad-button">0</button>
                        <button class="numpad-button delete-button" data-action="delete">DEL</button>
                    </div>
                </div>
                <button class="save-winnings-button" id="saveWinningsVND" data-i18n="saveWinningsButton">Save Winnings</button>
            </div>
        </div>

        <!-- Points to JPY Converter Section -->
        <div id="jpyConversionSection" class="content-section container">
            <h2 data-i18n="jpyConverterTitle">Points to JPY Converter</h2>
            
            <div class="converter-section">
                <div class="input-group">
                    <label for="pointsInputJPY" data-i18n="enterPointsLabel">Enter Points:</label>
                    <input type="number" id="pointsInputJPY" placeholder="Enter points..." min="0" inputmode="none">
                </div>
                <div class="input-group">
                    <label for="deductionPercentage" data-i18n="deductionPercentageLabel">Deduction Percentage (%):</label>
                    <!-- Replaced input with custom selector -->
                    <div class="deduction-selector">
                        <button class="deduction-button" data-action="decrement-1">-1%</button>
                        <button class="deduction-button" data-action="decrement-01">-0.1%</button>
                        <div class="deduction-value-display" id="deductionPercentageDisplay">10.0%</div>
                        <button class="deduction-button" data-action="increment-01">+0.1%</button>
                        <button class="deduction-button" data-action="increment-1">+1%</button>
                    </div>
                </div>
                
                <div class="currency-output" id="currencyOutputJPY">
                    <span data-i18n="enterPointsJPY">Enter points to see JPY value</span>
                </div>

                <!-- Numpad for JPY Converter -->
                <div class="numpad-container" id="numpadJPY">
                    <div class="numpad-grid">
                        <button class="numpad-button">1</button>
                        <button class="numpad-button">2</button>
                        <button class="numpad-button">3</button>
                        <button class="numpad-button">4</button>
                        <button class="numpad-button">5</button>
                        <button class="numpad-button">6</button>
                        <button class="numpad-button">7</button>
                        <button class="numpad-button">8</button>
                        <button class="numpad-button">9</button>
                        <button class="numpad-button clear-button" data-action="clear">C</button>
                        <button class="numpad-button">0</button>
                        <button class="numpad-button delete-button" data-action="delete">DEL</button>
                    </div>
                </div>
                <button class="save-winnings-button" id="saveWinningsJPY" data-i18n="saveWinningsButton">Save Winnings</button>
            </div>
        </div>

        <!-- Winnings History Section -->
        <div id="winningsHistorySection" class="content-section container">
            <h2 data-i18n="winningsHistoryTitle">Winnings History</h2>
            <button class="remove-history-button" id="removeCheckedWinningsButton" data-i18n="removeHistoryButton">Remove Checked Winnings</button>
            <div id="winningsHistoryList" class="history-list">
                <p data-i18n="loadingHistory">Loading winnings history...</p>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="content-section container">
            <h2 data-i18n="settingsTitle">Settings</h2>
            
            <div class="settings-option">
                <label for="languageSelect" data-i18n="languageLabel">Language</label>
                <select id="languageSelect" class="language-select">
                    <option value="en">English</option>
                    <option value="ko">한국어</option>
                    <option value="ja">日本語</option>
                </select>
            </div>

            <div class="settings-option">
                <label for="darkModeSelect" data-i18n="darkModeLabel">Dark Mode</label>
                <select id="darkModeSelect" class="dark-mode-select">
                    <option value="auto" data-i18n="darkModeAuto">Auto (device setting)</option>
                    <option value="on" data-i18n="darkModeOn">On</option>
                    <option value="off" data-i18n="darkModeOff">Off</option>
                </select>
            </div>

            <div class="settings-option" id="darkModeColorSchemeOption">
                <label for="darkModeColorSchemeSelect" data-i18n="darkModeColorSchemeLabel">Dark Mode Color</label>
                <select id="darkModeColorSchemeSelect" class="dark-mode-color-select">
                    <option value="royalGreen" data-i18n="colorRoyalGreen">Royal Green</option>
                    <option value="deepBlue" data-i18n="colorDeepBlue">Deep Blue</option>
                    <option value="charcoalGrey" data-i18n="colorCharcoalGrey">Charcoal Grey</option>
                    <option value="pitchBlack" data-i18n="colorPitchBlack">Pitch Black</option>
                </select>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, serverTimestamp, addDoc, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Counter and currency state
        let counter = 0; // This will represent the currently displayed counter value
        let vndSessionCounter = 0; // Separate counter for VND sessions
        let jpySessionCounter = 0; // Separate counter for JPY sessions
        let currentCounterCurrency = localStorage.getItem('selectedCurrency') || 'VND'; // Load saved currency or default to VND
        let firebaseInitialized = false; // Flag to track Firebase initialization
        let deductionPercentageValue = parseFloat(localStorage.getItem('deductionPercentage')) || 10.0; // Default to 10.0%

        // Debounce function for notes saving
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // Translation object
        const translations = {
            en: {
                appTitle: "Counter & Points Converter",
                menuCounter: "Counter & History",
                menuVNDConversion: "VND Conversion",
                menuJPYConversion: "JPY Conversion",
                menuWinningsHistory: "Winnings History", // New translation
                menuSettings: "Settings", // This will be the text for the menu item
                menuSettingsText: "Settings", // This will be the text next to the icon
                pachiTitle: "Pachi",
                counterTitle: "Counter",
                resetCounterButton: "Reset Session Counter",
                saveSessionButton: "Save Session",
                sessionHistoryTitle: "Session History",
                removeHistoryButton: "Remove Checked History",
                loadingHistory: "Loading history...",
                noHistory: "No session history available.",
                errorLoadingHistory: "Error loading history. Please try again. Check console for details.",
                enterPointsLabel: "Enter Points:",
                enterPointsVND: "Enter points to see VND value",
                vndConverterTitle: "Points to VND Converter",
                jpyConverterTitle: "Points to JPY Converter",
                deductionPercentageLabel: "Deduction Percentage (%):",
                enterPointsJPY: "Enter points to see JPY value",
                settingsTitle: "Settings",
                darkModeLabel: "Dark Mode",
                darkModeAuto: "Auto (device setting)",
                darkModeOn: "On",
                darkModeOff: "Off",
                darkModeColorSchemeLabel: "Dark Mode Color",
                colorRoyalGreen: "Royal Green",
                colorDeepBlue: "Deep Blue",
                colorCharcoalGrey: "Charcoal Grey",
                colorPitchBlack: "Pitch Black",
                languageLabel: "Language",
                points: "Points",
                saved: "Saved",
                straight: "Straight",
                afterDeduction: "After Deduction",
                firebaseInitLoading: "Please wait, initializing Firebase and loading history...",
                firebaseInitError: "Error initializing Firebase. This might be due to missing or incorrect Firebase configuration. History will not be saved.",
                firebaseConfigMessage: "History will be saved to your configured Firebase project.",
                vndShort: "VND",
                jpyShort: "JPY",
                saveWinningsButton: "Save Winnings", // New translation
                winningsHistoryTitle: "Winnings History", // New translation
                noWinningsHistory: "No winnings history available.", // New translation
                notesPlaceholder: "Add notes here..." // Placeholder for notes
            },
            ko: {
                appTitle: "카운터 & 포인트 변환기",
                menuCounter: "카운터 & 기록",
                menuVNDConversion: "VND 변환",
                menuJPYConversion: "JPY 변환",
                menuWinningsHistory: "수익 기록", // New translation
                menuSettings: "설정",
                menuSettingsText: "설정",
                pachiTitle: "파치",
                counterTitle: "카운터",
                resetCounterButton: "세션 카운터 초기화",
                saveSessionButton: "세션 저장",
                sessionHistoryTitle: "세션 기록",
                removeHistoryButton: "선택된 기록 삭제",
                loadingHistory: "기록 불러오는 중...",
                noHistory: "세션 기록이 없습니다.",
                errorLoadingHistory: "기록 불러오기 오류. 다시 시도해 주세요. 콘솔을 확인하세요.",
                enterPointsLabel: "포인트 입력:",
                enterPointsVND: "VND 값을 보려면 포인트를 입력하세요",
                vndConverterTitle: "포인트-VND 변환기",
                jpyConverterTitle: "포인트-JPY 변환기",
                deductionPercentageLabel: "공제율 (%):",
                enterPointsJPY: "JPY 값을 보려면 포인트를 입력하세요",
                settingsTitle: "설정",
                darkModeLabel: "다크 모드",
                darkModeAuto: "자동 (기기 설정)",
                darkModeOn: "켜짐",
                darkModeOff: "꺼짐",
                darkModeColorSchemeLabel: "다크 모드 색상",
                colorRoyalGreen: "로얄 그린",
                colorDeepBlue: "딥 블루",
                colorCharcoalGrey: "차콜 그레이",
                colorPitchBlack: "피치 블랙",
                languageLabel: "언어",
                points: "포인트",
                saved: "저장됨",
                straight: "직접",
                afterDeduction: "공제 후",
                firebaseInitLoading: "잠시 기다려 주세요. Firebase 초기화 및 기록 로드 중...",
                firebaseInitError: "Firebase 초기화 오류. Firebase 구성이 누락되었거나 잘못되었을 수 있습니다. 기록이 저장되지 않습니다.",
                firebaseConfigMessage: "기록은 구성된 Firebase 프로젝트에 저장됩니다.",
                vndShort: "VND",
                jpyShort: "JPY",
                saveWinningsButton: "수익 저장", // New translation
                winningsHistoryTitle: "수익 기록", // New translation
                noWinningsHistory: "수익 기록이 없습니다.", // New translation
                notesPlaceholder: "여기에 메모 추가..." // Placeholder for notes
            },
            ja: {
                appTitle: "カウンター＆ポイント変換",
                menuCounter: "カウンター＆履歴",
                menuVNDConversion: "VND変換",
                menuJPYConversion: "JPY変換",
                menuWinningsHistory: "勝利履歴", // New translation
                menuSettings: "設定",
                menuSettingsText: "設定",
                pachiTitle: "パチ",
                counterTitle: "カウンター",
                resetCounterButton: "セッションカウンターをリセット",
                saveSessionButton: "セッションを保存",
                sessionHistoryTitle: "セッション履歴",
                removeHistoryButton: "チェックされた履歴を削除",
                loadingHistory: "履歴を読み込み中...",
                noHistory: "セッション履歴がありません。",
                errorLoadingHistory: "履歴の読み込みエラー。もう一度お試しください。コンソールを確認してください。",
                enterPointsLabel: "ポイントを入力:",
                enterPointsVND: "VND値を見るにはポイントを入力してください",
                vndConverterTitle: "ポイントからVNDへの変換",
                jpyConverterTitle: "ポイントからJPYへの変換",
                deductionPercentageLabel: "控除率 (%):",
                enterPointsJPY: "JPY値を見るにはポイントを入力してください",
                settingsTitle: "設定",
                darkModeLabel: "ダークモード",
                darkModeAuto: "自動 (デバイス設定)",
                darkModeOn: "オン",
                darkModeOff: "オフ",
                darkModeColorSchemeLabel: "ダークモードの色",
                colorRoyalGreen: "ロイヤルグリーン",
                colorDeepBlue: "ディープブルー",
                colorCharcoalGrey: "チャコールグレー",
                colorPitchBlack: "ピッチブラック",
                languageLabel: "言語",
                points: "ポイント",
                saved: "保存済み",
                straight: "直接",
                afterDeduction: "控除後",
                firebaseInitLoading: "お待ちください。Firebaseの初期化と履歴の読み込み中...",
                firebaseInitError: "Firebaseの初期化エラー。Firebaseの設定が不足しているか、正しくない可能性があります。履歴は保存されません。",
                firebaseConfigMessage: "履歴は設定されたFirebaseプロジェクトに保存されます。",
                vndShort: "VND",
                jpyShort: "JPY",
                saveWinningsButton: "勝利を保存", // New translation
                winningsHistoryTitle: "勝利履歴", // New translation
                noWinningsHistory: "勝利履歴がありません。", // New translation
                notesPlaceholder: "ここにメモを追加..." // Placeholder for notes
            }
        };

        // Dark mode color schemes
        const darkModeColors = {
            royalGreen: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
            deepBlue: 'linear-gradient(135deg, #1a2a40 0%, #2a3a50 100%)',
            charcoalGrey: 'linear-gradient(135deg, #222222 0%, #333333 100%)', /* Darker charcoal */
            pitchBlack: 'linear-gradient(135deg, #000000 0%, #1a1a1a 100%)' /* Pitch Black */
        };

        let currentLanguage = localStorage.getItem('language') || 'en'; // Load saved language or default to English

        function applyTranslations(lang) {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            // Update specific elements that might not use data-i18n easily
            document.querySelector('title').textContent = translations[lang].appTitle;
            // Update options in dark mode color select
            const darkModeColorSchemeSelect = document.getElementById('darkModeColorSchemeSelect');
            if (darkModeColorSchemeSelect) {
                Array.from(darkModeColorSchemeSelect.options).forEach(option => {
                    const key = option.getAttribute('data-i18n');
                    if (translations[lang] && translations[lang][key]) {
                        option.textContent = translations[lang][key];
                    }
                });
            }

            // Re-render history to apply language changes to dynamic content
            if (firebaseInitialized && userId && db) {
                loadSessionHistory();
                loadWinningsHistory(); // Also reload winnings history
            } else {
                 // Update initial loading/error messages if Firebase isn't ready yet
                const historyListElement = document.getElementById('sessionHistoryList');
                if (historyListElement) {
                    if (!firebaseInitialized) {
                        historyListElement.innerHTML = `<p>${translations[lang].firebaseInitLoading}</p>`;
                    } else if (!userId || !db) {
                        historyListElement.innerHTML = `<p>${translations[lang].firebaseInitError}</p>`;
                    }
                }
                const winningsHistoryListElement = document.getElementById('winningsHistoryList');
                if (winningsHistoryListElement) {
                    if (!firebaseInitialized) {
                        winningsHistoryListElement.innerHTML = `<p>${translations[lang].firebaseInitLoading}</p>`;
                    } else if (!userId || !db) {
                        winningsHistoryListElement.innerHTML = `<p>${translations[lang].firebaseInitError}</p>`;
                    }
                }
            }
        }

        // Function to initialize Firebase
        async function initializeFirebase() {
            console.log("Attempting to initialize Firebase...");
            let firebaseConfig = {};
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    console.log("Firebase config loaded from __firebase_config.");
                } catch (e) {
                    console.error("Error parsing __firebase_config:", e);
                    document.getElementById('sessionHistoryList').innerHTML = `<p>${translations[currentLanguage].firebaseInitError}</p>`;
                    return; // Stop initialization if config is bad
                }
            } else {
                console.warn("No __firebase_config found. Using provided Firebase config for persistent history.");
                // YOUR PROVIDED FIREBASE CONFIG
                firebaseConfig = {
                    apiKey: "AIzaSyAsI2M572ZMGRcopIduikPRTjlBj4Zv5WI",
                    authDomain: "pachi-app-f2228.firebaseapp.com",
                    projectId: "pachi-app-f2228",
                    storageBucket: "pachi-app-f2228.firebasestorage.app",
                    messagingSenderId: "921460524528",
                    appId: "1:921460524528:web:488defd44091bc55d8c935",
                    measurementId: "G-XDZPGE5WJ5"
                };
                document.getElementById('sessionHistoryList').innerHTML = `<p>${translations[currentLanguage].firebaseConfigMessage}</p>`;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app and Firestore initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated. User ID:", userId);
                        firebaseInitialized = true; // Set flag once user is confirmed
                        // Now that Firebase is ready and user is authenticated, load data
                        await loadSessionHistory();
                        await loadWinningsHistory(); // Load winnings history too
                        updateCounterCurrencyDisplay();
                        setCounterCurrency(currentCounterCurrency); // Ensure correct button is active and counter value is set
                    } else {
                        console.log("No user authenticated. Attempting anonymous sign-in or custom token sign-in.");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                console.log("Signed in with custom token.");
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously (fallback).");
                            }
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('sessionHistoryList').innerHTML = `<p>${translations[currentLanguage].firebaseInitError}</p>`;
                // Set firebaseInitialized to false if initialization fails, so Firestore operations are skipped.
                firebaseInitialized = false;
            }
        }

        // Function to load session history from Firestore
        async function loadSessionHistory() {
            const historyListElement = document.getElementById('sessionHistoryList');
            // Only show loading message if Firebase is not yet initialized or userId is not set
            if (!firebaseInitialized || !userId || !db) { // Check for all prerequisites
                if (historyListElement) {
                    historyListElement.innerHTML = `<p>${translations[currentLanguage].firebaseInitLoading}</p>`;
                }
                console.log("loadSessionHistory called before Firebase/User initialized. State:", { firebaseInitialized, userId: !!userId, db: !!db });
                return; // Exit if not ready
            }
            console.log("Loading session history...");

            const sessionCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pachinkoSessions`);
            // Removed orderBy from query to avoid potential index issues in some environments.
            // Sorting will now be done client-side.
            const q = query(sessionCollectionRef); 
            
            try {
                const querySnapshot = await getDocs(q);
                let history = [];
                querySnapshot.forEach((doc) => {
                    history.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort history chronologically (oldest at top, newest at bottom) in JavaScript
                history.sort((a, b) => {
                    const tsA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const tsB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return tsA - tsB;
                });

                displayHistory(history, 'sessionHistoryList', 'history-checkbox', updateSessionNote); // This handles empty history by showing "No session history available."
                console.log("Session history loaded successfully.");

            } catch (e) {
                console.error("Error loading session history:", e);
                if (historyListElement) {
                    historyListElement.innerHTML = `<p>${translations[currentLanguage].errorLoadingHistory}</p>`;
                }
            }
        }

        // Function to load winnings history from Firestore
        async function loadWinningsHistory() {
            const winningsHistoryListElement = document.getElementById('winningsHistoryList');
            if (!firebaseInitialized || !userId || !db) {
                if (winningsHistoryListElement) {
                    winningsHistoryListElement.innerHTML = `<p>${translations[currentLanguage].firebaseInitLoading}</p>`;
                }
                console.log("loadWinningsHistory called before Firebase/User initialized. State:", { firebaseInitialized, userId: !!userId, db: !!db });
                return;
            }
            console.log("Loading winnings history...");

            const winningsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pachinkoWinnings`);
            const q = query(winningsCollectionRef);

            try {
                const querySnapshot = await getDocs(q);
                let winnings = [];
                querySnapshot.forEach((doc) => {
                    winnings.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                winnings.sort((a, b) => {
                    const tsA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const tsB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return tsA - tsB;
                });

                displayHistory(winnings, 'winningsHistoryList', 'winnings-checkbox', updateWinningsNote);
                console.log("Winnings history loaded successfully.");

            } catch (e) {
                console.error("Error loading winnings history:", e);
                if (winningsHistoryListElement) {
                    winningsHistoryListElement.innerHTML = `<p>${translations[currentLanguage].errorLoadingHistory}</p>`;
                }
            }
        }


        // Function to save the current session to Firestore
        async function saveSession() {
            if (!userId) {
                console.warn("User not authenticated yet. Cannot save session.");
                return;
            }
            if (!firebaseInitialized || !db) {
                console.warn("Firebase not fully initialized. Cannot save session.");
                return;
            }

            // Use the currently displayed counter value for saving
            let pointsToSave = 0;
            if (currentCounterCurrency === 'VND') {
                pointsToSave = vndSessionCounter;
            } else { // JPY
                pointsToSave = jpySessionCounter;
            }

            if (pointsToSave === 0) {
                console.log("Cannot save an empty session.");
                return; // Prevent saving empty sessions
            }

            const sessionCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pachinkoSessions`);

            // Calculate converted values for both VND and JPY based on current counter
            const convertedVND = pointsToSave * 500000; // 1 point = 500,000 VND
            const convertedJPY = pointsToSave * 1000;   // 1 point = 1,000 JPY

            try {
                await addDoc(sessionCollectionRef, {
                    timestamp: serverTimestamp(),
                    points: pointsToSave,
                    currencyAtSave: currentCounterCurrency, // Record which currency was active when saved
                    convertedVND: convertedVND,
                    convertedJPY: convertedJPY,
                    notes: "" // Initialize notes field as empty
                });
                console.log("Session saved successfully!");
                // Optionally reset the counter after saving
                resetCounter(); // This will reset the currently active counter
                loadSessionHistory(); // Reload history to show the new entry
            } catch (e) {
                console.error("Error saving session:", e);
            }
        }

        // Function to save current converter value as winnings
        async function saveWinnings(currencyType) {
            if (!userId) {
                console.warn("User not authenticated yet. Cannot save winnings.");
                return;
            }
            if (!firebaseInitialized || !db) {
                console.warn("Firebase not fully initialized. Cannot save winnings.");
                return;
            }

            let points = 0;
            let convertedAmount = 0;
            let currencySymbol = '';

            if (currencyType === 'VND') {
                points = parseFloat(document.getElementById('pointsInputVND').value) || 0;
                convertedAmount = (points / 2000) * 500000;
                currencySymbol = 'VND';
            } else if (currencyType === 'JPY') {
                points = parseFloat(document.getElementById('pointsInputJPY').value) || 0;
                const jpyValue = points * 4;
                convertedAmount = jpyValue * (1 - (deductionPercentageValue / 100));
                currencySymbol = 'JPY';
            }

            if (points === 0) {
                console.log("Cannot save winnings for 0 points.");
                return;
            }

            const winningsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pachinkoWinnings`);

            try {
                await addDoc(winningsCollectionRef, {
                    timestamp: serverTimestamp(),
                    points: points,
                    convertedAmount: convertedAmount,
                    currencyType: currencySymbol,
                    deductionPercentage: currencyType === 'JPY' ? deductionPercentageValue : null, // Save deduction for JPY
                    notes: "" // Initialize notes field as empty
                });
                console.log(`Winnings saved successfully for ${currencyType}!`);
                // Clear the input field after saving winnings
                if (currencyType === 'VND') {
                    document.getElementById('pointsInputVND').value = '';
                    convertPointsVND(); // Update display
                } else if (currencyType === 'JPY') {
                    document.getElementById('pointsInputJPY').value = '';
                    convertPointsJPY(); // Update display
                }
                loadWinningsHistory(); // Reload winnings history to show the new entry
            } catch (e) {
                console.error("Error saving winnings:", e);
            }
        }


        // Function to update a specific session's notes in Firestore
        const updateSessionNote = debounce(async (sessionId, noteText) => {
            if (!userId) {
                console.warn("User not authenticated. Cannot update note.");
                return;
            }
            if (!db) {
                console.warn("Firestore not initialized.");
                return;
            }

            const sessionDocRef = doc(db, `artifacts/${appId}/users/${userId}/pachinkoSessions/${sessionId}`);
            try {
                await updateDoc(sessionDocRef, {
                    notes: noteText
                });
                console.log(`Note for session ${sessionId} updated.`);
            } catch (e) {
                console.error(`Error updating note for session ${sessionId}:`, e);
            }
        }, 500); // Debounce by 500ms

        // Function to update a specific winnings entry's notes in Firestore
        const updateWinningsNote = debounce(async (winningsId, noteText) => {
            if (!userId) {
                console.warn("User not authenticated. Cannot update winnings note.");
                return;
            }
            if (!db) {
                console.warn("Firestore not initialized.");
                return;
            }

            const winningsDocRef = doc(db, `artifacts/${appId}/users/${userId}/pachinkoWinnings/${winningsId}`);
            try {
                await updateDoc(winningsDocRef, {
                    notes: noteText
                });
                console.log(`Note for winnings ${winningsId} updated.`);
            } catch (e) {
                console.error(`Error updating note for winnings ${winningsId}:`, e);
            }
        }, 500); // Debounce by 500ms

        // Function to display history (generalized for sessions and winnings)
        function displayHistory(history, listElementId, checkboxClass, updateNoteFunction) {
            const listElement = document.getElementById(listElementId);
            listElement.innerHTML = ''; // Clear previous history

            if (history.length === 0) {
                listElement.innerHTML = `<p>${listElementId === 'sessionHistoryList' ? translations[currentLanguage].noHistory : translations[currentLanguage].noWinningsHistory}</p>`;
                return;
            }

            history.forEach((item, index) => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.classList.add('history-item');
                historyItemDiv.dataset.itemId = item.id; // Use generic itemId

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.classList.add(checkboxClass); // Use dynamic class
                historyItemDiv.appendChild(checkbox);
                
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('history-item-content');

                const historyLineDiv = document.createElement('div');
                historyLineDiv.classList.add('history-item-line'); // Container for inline content

                const numberSpan = document.createElement('span');
                numberSpan.classList.add('history-number');
                numberSpan.textContent = `${index + 1}.`;
                historyLineDiv.appendChild(numberSpan);

                const date = item.timestamp ? new Date(item.timestamp.toDate()).toLocaleString() : 'N/A';
                const datetimeSpan = document.createElement('span');
                datetimeSpan.classList.add('history-datetime');
                datetimeSpan.textContent = `${translations[currentLanguage].saved}: ${date}`;
                historyLineDiv.appendChild(datetimeSpan);

                const detailsSpan = document.createElement('span');
                detailsSpan.classList.add('history-details');
                
                let currencyDisplay = '';
                if (listElementId === 'sessionHistoryList') {
                    // Logic for session history
                    if (item.currencyAtSave === 'VND') {
                        currencyDisplay = formatCurrency(item.convertedVND, 'VND');
                    } else if (item.currencyAtSave === 'JPY') {
                        currencyDisplay = formatCurrency(item.convertedJPY, 'JPY');
                    } else {
                        currencyDisplay = `VND: ${formatCurrency(item.convertedVND, 'VND')} / JPY: ${formatCurrency(item.convertedJPY, 'JPY')}`;
                    }
                    detailsSpan.textContent = `${translations[currentLanguage].points}: ${item.points} | ${currencyDisplay}`;
                } else if (listElementId === 'winningsHistoryList') {
                    // Logic for winnings history
                    let convertedFormatted = formatCurrency(item.convertedAmount, item.currencyType);
                    let deductionInfo = item.deductionPercentage !== null ? ` (${item.deductionPercentage.toFixed(1)}% ded.)` : '';
                    detailsSpan.textContent = `${translations[currentLanguage].points}: ${item.points} | ${convertedFormatted}${deductionInfo}`;
                }
                
                historyLineDiv.appendChild(detailsSpan);
                contentDiv.appendChild(historyLineDiv);

                // Notes Textbox
                const notesTextbox = document.createElement('textarea');
                notesTextbox.classList.add('history-notes-textbox');
                notesTextbox.placeholder = translations[currentLanguage].notesPlaceholder;
                notesTextbox.value = item.notes || ''; // Populate with existing notes
                notesTextbox.dataset.itemId = item.id; // Store item ID for saving
                notesTextbox.addEventListener('input', (event) => {
                    updateNoteFunction(event.target.dataset.itemId, event.target.value);
                });
                contentDiv.appendChild(notesTextbox);

                historyItemDiv.appendChild(contentDiv);
                listElement.appendChild(historyItemDiv);
            });
        }

        // Function to remove checked history items (generalized)
        async function removeCheckedItems(listElementId, checkboxClass, collectionName) {
            if (!userId) {
                console.warn("User not authenticated. Cannot remove items.");
                return;
            }
            if (!firebaseInitialized || !db) {
                console.warn("Firebase not fully initialized. Cannot remove items.");
                return;
            }

            const checkedItems = document.querySelectorAll(`.${checkboxClass}:checked`);
            if (checkedItems.length === 0) {
                console.log("No items checked for removal.");
                return;
            }

            const deletePromises = [];
            checkedItems.forEach(checkbox => {
                const itemId = checkbox.closest('.history-item').dataset.itemId;
                if (itemId) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${itemId}`);
                    deletePromises.push(deleteDoc(docRef));
                    console.log(`Attempting to delete item: ${itemId} from ${collectionName}`); // Debug log
                }
            });

            try {
                await Promise.all(deletePromises);
                console.log("Selected items removed successfully!");
                if (collectionName === 'pachinkoSessions') {
                    loadSessionHistory(); // Reload session history
                } else if (collectionName === 'pachinkoWinnings') {
                    loadWinningsHistory(); // Reload winnings history
                }
            } catch (e) {
                console.error("Error removing items:", e);
            }
        }

        function incrementCounter(value) {
            if (currentCounterCurrency === 'VND') {
                vndSessionCounter += value;
                counter = vndSessionCounter; // Update the displayed counter
            } else { // JPY
                jpySessionCounter += value;
                counter = jpySessionCounter; // Update the displayed counter
            }
            document.getElementById('counter').textContent = counter;
            updateCounterCurrencyDisplay();
        }

        function resetCounter() {
            if (currentCounterCurrency === 'VND') {
                vndSessionCounter = 0;
            } else { // JPY
                jpySessionCounter = 0;
            }
            counter = 0; // Reset the displayed counter to 0
            document.getElementById('counter').textContent = counter;
            updateCounterCurrencyDisplay(); // Update converted value to 0
        }

        function formatCurrency(value, currencySymbol) {
            if (value === 0) return `0 ${currencySymbol}`;
            
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 2, 
                useGrouping: true
            });

            let formattedValue;
            if (Math.abs(value) >= 1000000) {
                const millions = value / 1000000;
                formattedValue = formatter.format(millions) + 'M';
            } else if (Math.abs(value) >= 1000) {
                const thousands = value / 1000;
                formattedValue = formatter.format(thousands) + 'K';
            } else {
                formattedValue = formatter.format(value);
            }
            // Remove trailing .0 if it's a whole number after formatting
            formattedValue = formattedValue.replace(/\.0+([MK]?)$/, '$1');
            return `${formattedValue} ${currencySymbol}`;
        }

        function setCounterCurrency(currency) {
            currentCounterCurrency = currency;
            localStorage.setItem('selectedCurrency', currency); // Save selected currency

            // Update the main counter display to reflect the selected currency's specific counter
            if (currentCounterCurrency === 'VND') {
                counter = vndSessionCounter;
            } else { // JPY
                counter = jpySessionCounter;
            }
            document.getElementById('counter').textContent = counter; // Update main counter display
            updateCounterCurrencyDisplay();
            
            // Update sidebar toggle active state
            const sidebarToggleVND = document.getElementById('sidebarToggleVND');
            const sidebarToggleJPY = document.getElementById('sidebarToggleJPY');
            const sidebarCurrencyToggleDiv = document.getElementById('sidebarCurrencyToggle');

            if (currency === 'VND') {
                sidebarToggleVND.classList.add('active');
                sidebarToggleJPY.classList.remove('active');
                sidebarCurrencyToggleDiv.classList.remove('jpy-active');
            } else {
                sidebarToggleVND.classList.remove('active');
                sidebarToggleJPY.classList.add('active');
                sidebarCurrencyToggleDiv.classList.add('jpy-active');
            }

            updateMenuCurrencyVisibility(); // Call new function to update menu visibility
            showSection('counterSection'); // Always go back to counter page after currency selection
        }

        function updateCounterCurrencyDisplay() {
            const convertedCounterValueElement = document.getElementById('convertedCounterValue');
            let value;
            let symbol;

            if (currentCounterCurrency === 'VND') {
                // 1 point = 500,000 VND
                value = counter * 500000;
                symbol = 'VND';
            } else { // JPY
                // 1 point = 1,000 JPY
                value = counter * 1000;
                symbol = 'JPY';
            }
            convertedCounterValueElement.textContent = formatCurrency(value, symbol);
        }

        function convertPointsVND() {
            const pointsInput = document.getElementById('pointsInputVND');
            const currencyOutput = document.getElementById('currencyOutputVND');
            const points = parseFloat(pointsInput.value) || 0;
            
            if (points === 0) {
                currencyOutput.textContent = translations[currentLanguage].enterPointsVND;
                return;
            }
            
            // 2000 points = 500,000 VND
            const vndValue = (points / 2000) * 500000;
            
            currencyOutput.textContent = formatCurrency(vndValue, 'VND');
        }

        function convertPointsJPY() {
            const pointsInput = document.getElementById('pointsInputJPY');
            const currencyOutput = document.getElementById('currencyOutputJPY');
            
            const points = parseFloat(pointsInput.value) || 0;
            // Use the global deductionPercentageValue
            const deductionPercentage = deductionPercentageValue; 
            
            if (points === 0) {
                currencyOutput.innerHTML = `<span data-i18n="enterPointsJPY">${translations[currentLanguage].enterPointsJPY}</span>`;
                return;
            }
            
            // Each point is 4 JPY
            const jpyValue = points * 4;
            
            const deductedValue = jpyValue * (1 - (deductionPercentage / 100));

            const formattedJPY = formatCurrency(jpyValue, 'JPY');
            const formattedDeductedJPY = formatCurrency(deductedValue, 'JPY');
            
            currencyOutput.innerHTML = `<div>${translations[currentLanguage].straight}: ${formattedJPY}</div><div>${translations[currentLanguage].afterDeduction}: ${formattedDeductedJPY}</div>`;
        }

        // --- Dark Mode Logic ---
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        function applySystemDarkMode() {
            const darkModeColor = localStorage.getItem('darkModeColorScheme') || 'royalGreen';
            if (darkModeMediaQuery.matches) {
                document.body.classList.add('dark-mode');
                document.body.style.background = darkModeColors[darkModeColor];
            } else {
                document.body.classList.remove('dark-mode');
                document.body.style.background = ''; // Reset to default light mode background
            }
            updateDarkModeColorOptionVisibility();
        }

        function setDarkModePreference(preference) {
            localStorage.setItem('darkModePreference', preference);
            // Remove previous listener to avoid multiple listeners
            darkModeMediaQuery.removeEventListener('change', applySystemDarkMode); 

            const darkModeColor = localStorage.getItem('darkModeColorScheme') || 'royalGreen';

            if (preference === 'auto') {
                applySystemDarkMode(); // Apply current system setting
                darkModeMediaQuery.addEventListener('change', applySystemDarkMode); // Listen for future system changes
            } else if (preference === 'on') {
                document.body.classList.add('dark-mode');
                document.body.style.background = darkModeColors[darkModeColor];
            } else { // preference === 'off'
                document.body.classList.remove('dark-mode');
                document.body.style.background = ''; // Reset to default light mode background
            }
            document.getElementById('darkModeSelect').value = preference;
            updateDarkModeColorOptionVisibility();
        }

        function setDarkModeColorScheme(colorScheme) {
            localStorage.setItem('darkModeColorScheme', colorScheme);
            const currentPreference = localStorage.getItem('darkModePreference') || 'auto';
            if (currentPreference === 'on' || (currentPreference === 'auto' && darkModeMediaQuery.matches)) {
                document.body.style.background = darkModeColors[colorScheme];
            }
            document.getElementById('darkModeColorSchemeSelect').value = colorScheme;
        }

        function updateDarkModeColorOptionVisibility() {
            const darkModeColorSchemeOption = document.getElementById('darkModeColorSchemeOption');
            const currentPreference = localStorage.getItem('darkModePreference') || 'auto';
            if (currentPreference === 'on' || (currentPreference === 'auto' && darkModeMediaQuery.matches)) {
                darkModeColorSchemeOption.style.display = 'flex';
            } else {
                darkModeColorSchemeOption.style.display = 'none';
            }
        }

        // --- Menu and Content Switching Logic ---
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Update active state for sidebar menu items
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            if (sectionId === 'counterSection') {
                document.getElementById('menuCounter').classList.add('active');
            } else if (sectionId === 'vndConversionSection') {
                document.getElementById('menuVNDConversion').classList.add('active');
            } else if (sectionId === 'jpyConversionSection') {
                document.getElementById('menuJPYConversion').classList.add('active');
            } else if (sectionId === 'winningsHistorySection') { // New section
                document.getElementById('menuWinningsHistory').classList.add('active');
                loadWinningsHistory(); // Load history when tab is opened
            } else if (sectionId === 'settingsSection') {
                document.getElementById('menuSettings').classList.add('active');
            }

            // Close sidebar after selection
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('menuIcon').classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }

        // Function to update visibility of currency conversion menu items
        function updateMenuCurrencyVisibility() {
            const menuVND = document.getElementById('menuVNDConversion');
            const menuJPY = document.getElementById('menuJPYConversion');

            if (currentCounterCurrency === 'VND') {
                menuVND.style.display = 'flex'; // Show VND
                menuJPY.style.display = 'none'; // Hide JPY
            } else { // JPY
                menuVND.style.display = 'none'; // Hide VND
                menuJPY.style.display = 'flex'; // Show JPY
            }
        }

        // Numpad logic
        function setupNumpad(numpadId, inputId, convertFunction) {
            const numpad = document.getElementById(numpadId);
            const inputField = document.getElementById(inputId);

            numpad.addEventListener('click', (event) => {
                const button = event.target.closest('.numpad-button');
                if (!button) return;

                const action = button.dataset.action;
                const value = button.textContent;

                if (action === 'clear') {
                    inputField.value = '';
                } else if (action === 'delete') {
                    inputField.value = inputField.value.slice(0, -1);
                } else { // Number button
                    inputField.value += value;
                }
                convertFunction(); // Recalculate after each input
            });

            // Prevent software keyboard from appearing on focus
            inputField.addEventListener('focus', (event) => {
                event.target.blur();
            });
        }

        // Deduction Percentage Selector Logic
        function updateDeductionDisplay() {
            const display = document.getElementById('deductionPercentageDisplay');
            if (display) { // Check if element exists before updating
                display.textContent = deductionPercentageValue.toFixed(1) + '%';
            }
            convertPointsJPY(); // Recalculate JPY conversion with new deduction
        }

        function adjustDeduction(step) {
            deductionPercentageValue = parseFloat((deductionPercentageValue + step).toFixed(1));
            if (deductionPercentageValue < 0) {
                deductionPercentageValue = 0;
            } else if (deductionPercentageValue > 25) {
                deductionPercentageValue = 25;
            }
            localStorage.setItem('deductionPercentage', deductionPercentageValue);
            updateDeductionDisplay();
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Apply initial dark mode state
            const savedDarkModePreference = localStorage.getItem('darkModePreference') || 'auto'; // Default to auto
            const savedDarkModeColor = localStorage.getItem('darkModeColorScheme') || 'royalGreen'; // Default color
            setDarkModePreference(savedDarkModePreference);
            setDarkModeColorScheme(savedDarkModeColor); // Apply color after preference

            // Apply initial language
            const savedLanguage = localStorage.getItem('language');
            if (savedLanguage && translations[savedLanguage]) {
                currentLanguage = savedLanguage;
                document.getElementById('languageSelect').value = savedLanguage;
            } else {
                currentLanguage = 'en'; // Default to English
                document.getElementById('languageSelect').value = 'en';
            }
            applyTranslations(currentLanguage);

            // Initialize currency toggle and menu visibility based on saved preference
            setCounterCurrency(currentCounterCurrency); // This will also call updateMenuCurrencyVisibility

            // Initialize deduction percentage display
            updateDeductionDisplay();

            // Menu Toggle
            document.getElementById('menuIcon').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const menuIcon = document.getElementById('menuIcon');
                sidebar.classList.toggle('open');
                menuIcon.classList.toggle('open');
                document.body.classList.toggle('sidebar-open');
            });

            // Menu Item Clicks
            document.getElementById('menuCounter').addEventListener('click', () => showSection('counterSection'));
            document.getElementById('menuVNDConversion').addEventListener('click', () => {
                showSection('vndConversionSection');
                convertPointsVND(); // Recalculate on section switch
            });
            document.getElementById('menuJPYConversion').addEventListener('click', () => {
                showSection('jpyConversionSection');
                convertPointsJPY(); // Recalculate on section switch
            });
            document.getElementById('menuWinningsHistory').addEventListener('click', () => showSection('winningsHistorySection')); // New menu item
            document.getElementById('menuSettings').addEventListener('click', () => showSection('settingsSection'));

            // Sidebar Currency Toggle
            document.getElementById('sidebarToggleVND').addEventListener('click', () => setCounterCurrency('VND'));
            document.getElementById('sidebarToggleJPY').addEventListener('click', () => setCounterCurrency('JPY'));
            
            // Counter Buttons
            document.getElementById('increment1').addEventListener('click', () => incrementCounter(1));
            document.getElementById('increment5').addEventListener('click', () => incrementCounter(5));
            document.getElementById('increment10').addEventListener('click', () => incrementCounter(10));
            document.getElementById('resetCounterButton').addEventListener('click', resetCounter);
            document.getElementById('saveSessionButton').addEventListener('click', saveSession); 
            document.getElementById('removeCheckedHistoryButton').addEventListener('click', () => removeCheckedItems('sessionHistoryList', 'history-checkbox', 'pachinkoSessions'));

            // Setup Numpads
            setupNumpad('numpadVND', 'pointsInputVND', convertPointsVND);
            setupNumpad('numpadJPY', 'pointsInputJPY', convertPointsJPY);

            // Save Winnings Buttons
            document.getElementById('saveWinningsVND').addEventListener('click', () => saveWinnings('VND'));
            document.getElementById('saveWinningsJPY').addEventListener('click', () => saveWinnings('JPY'));
            document.getElementById('removeCheckedWinningsButton').addEventListener('click', () => removeCheckedItems('winningsHistoryList', 'winnings-checkbox', 'pachinkoWinnings'));


            // Deduction Percentage Buttons
            document.querySelector('.deduction-selector [data-action="decrement-1"]').addEventListener('click', () => adjustDeduction(-1));
            document.querySelector('.deduction-selector [data-action="decrement-01"]').addEventListener('click', () => adjustDeduction(-0.1));
            document.querySelector('.deduction-selector [data-action="increment-01"]').addEventListener('click', () => adjustDeduction(0.1));
            document.querySelector('.deduction-selector [data-action="increment-1"]').addEventListener('click', () => adjustDeduction(1));


            // Settings Event Listeners
            document.getElementById('darkModeSelect').addEventListener('change', (event) => {
                setDarkModePreference(event.target.value);
            });

            document.getElementById('darkModeColorSchemeSelect').addEventListener('change', (event) => {
                setDarkModeColorScheme(event.target.value);
            });

            document.getElementById('languageSelect').addEventListener('change', (event) => {
                currentLanguage = event.target.value;
                localStorage.setItem('language', currentLanguage);
                applyTranslations(currentLanguage);
            });
        });

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
